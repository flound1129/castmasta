# Debian Package Build Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a self-contained arm64 `.deb` for Raspbian Trixie that installs castmasta as a systemd service on `0.0.0.0:16384`.

**Architecture:** `dh-virtualenv` bundles a complete Python venv (all pip deps + piper binary) into the deb. The default piper voice model (`en_US-lessac-medium`) is bundled at `/usr/share/castmasta/voices/`. The service runs as the unprivileged `castmasta` system user. Build runs in a `arm64v8/debian:trixie` Docker container with `--network=host`.

**Tech Stack:** dh-virtualenv, dpkg-buildpackage, Docker arm64v8/debian:trixie, fastmcp HTTP transport, systemd

---

### Task 1: Add `--host`/`--port` to `castmasta-mcp` and update voice dir fallback

**Files:**
- Modify: `castmasta/mcp_server.py:432-437`
- Modify: `castmasta/agent.py` (PIPER_VOICE_DATA_DIR)

**Step 1: Update `mcp_server.py` main() to accept host/port args**

Replace the current `main()` in `castmasta/mcp_server.py`:

```python
def main():
    mcp.run(transport="stdio")
```

With:

```python
import click

@click.command()
@click.option("--host", default="127.0.0.1", help="Host to listen on")
@click.option("--port", default=16384, help="Port to listen on")
@click.option("--stdio", "transport", flag_value="stdio", default=True, help="Use stdio transport (default)")
@click.option("--http", "transport", flag_value="http", help="Use HTTP transport")
def main(host, port, transport):
    if transport == "http":
        mcp.run(transport="http", host=host, port=port)
    else:
        mcp.run(transport="stdio")
```

**Step 2: Update `PIPER_VOICE_DATA_DIR` in `castmasta/agent.py`**

Find the current line (near top of file, after imports):
```python
PIPER_VOICE_DATA_DIR = Path.home() / ".local/share/piper-voices"
```

Replace with:
```python
_USER_VOICE_DIR = Path.home() / ".local/share/piper-voices"
_SYSTEM_VOICE_DIR = Path("/usr/share/castmasta/voices")
PIPER_VOICE_DATA_DIR = _USER_VOICE_DIR if _USER_VOICE_DIR.exists() else _SYSTEM_VOICE_DIR
```

**Step 3: Run tests**

```bash
.venv/bin/pytest tests/ -q
```
Expected: all 56 tests pass.

**Step 4: Smoke-test the HTTP transport locally**

```bash
.venv/bin/castmasta-mcp --http --host 127.0.0.1 --port 16384 &
sleep 2
curl -s http://127.0.0.1:16384/ | head -5
kill %1
```
Expected: curl returns some HTTP response (not a connection refused).

**Step 5: Commit**

```bash
git add castmasta/mcp_server.py castmasta/agent.py
git commit -m "feat: add --host/--port to castmasta-mcp, fallback voice dir for system install"
```

---

### Task 2: Create `debian/` package structure

**Files:**
- Create: `debian/control`
- Create: `debian/rules`
- Create: `debian/compat`
- Create: `debian/changelog`
- Create: `debian/postinst`
- Create: `debian/prerm`

**Step 1: Create `debian/compat`**

```
13
```

**Step 2: Create `debian/changelog`**

```
castmasta (0.2.0-1) trixie; urgency=low

  * Initial release.

 -- Adam <adam@localhost>  Sat, 22 Feb 2026 00:00:00 +0000
```

**Step 3: Create `debian/control`**

```
Source: castmasta
Section: net
Priority: optional
Maintainer: Adam <adam@localhost>
Build-Depends:
 debhelper-compat (= 13),
 dh-virtualenv (>= 1.2),
 python3-dev,
 python3-pip,
 libssl-dev,
 libffi-dev,
 libasound2-dev,
 build-essential
Standards-Version: 4.6.0

Package: castmasta
Architecture: arm64
Depends: ${shlibs:Depends}, ${misc:Depends}, python3, libasound2
Description: LLM agent for controlling AirPlay and Google Cast devices
 CastMasta controls AirPlay and Google Cast devices, providing text-to-speech
 announcement support via piper TTS. Exposes an MCP server for LLM integration.
```

**Step 4: Create `debian/rules`**

```makefile
#!/usr/bin/make -f

export DH_VIRTUALENV_INSTALL_ROOT = /usr/lib

%:
	dh $@ --with python-virtualenv

override_dh_virtualenv:
	dh_virtualenv \
		--install-suffix castmasta \
		--python /usr/bin/python3 \
		--builtin-venv \
		--preinstall setuptools \
		--preinstall wheel

override_dh_install:
	dh_install
	install -d debian/castmasta/usr/share/castmasta/voices
	install -m 644 debian/voices/en_US-lessac-medium.onnx \
		debian/castmasta/usr/share/castmasta/voices/
	install -m 644 debian/voices/en_US-lessac-medium.onnx.json \
		debian/castmasta/usr/share/castmasta/voices/
```

Make it executable: `chmod +x debian/rules`

**Step 5: Create `debian/postinst`**

```bash
#!/bin/sh
set -e

case "$1" in
    configure)
        if ! getent passwd castmasta > /dev/null 2>&1; then
            adduser --system --group \
                --home /var/lib/castmasta \
                --shell /usr/sbin/nologin \
                --no-create-home \
                castmasta
        fi
        mkdir -p /var/lib/castmasta
        chown castmasta:castmasta /var/lib/castmasta
        chmod 700 /var/lib/castmasta
        ;;
esac

#DEBHELPER#
```

Make it executable: `chmod +x debian/postinst`

**Step 6: Create `debian/prerm`**

```bash
#!/bin/sh
set -e

case "$1" in
    remove|purge)
        if systemctl is-active --quiet castmasta 2>/dev/null; then
            systemctl stop castmasta
        fi
        ;;
esac

#DEBHELPER#
```

Make it executable: `chmod +x debian/prerm`

**Step 7: Commit**

```bash
git add debian/
git commit -m "chore: add debian/ package structure for dh-virtualenv build"
```

---

### Task 3: Create systemd unit file

**Files:**
- Create: `debian/castmasta.service`

**Step 1: Create `debian/castmasta.service`**

```ini
[Unit]
Description=CastMasta AirPlay/Google Cast MCP agent
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=castmasta
Group=castmasta
ExecStart=/usr/lib/castmasta/bin/castmasta-mcp --http --host 0.0.0.0 --port 16384
Restart=on-failure
RestartSec=5
StateDirectory=castmasta
StateDirectoryMode=0700
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/lib/castmasta
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
```

Note: We call the venv binary directly (`/usr/lib/castmasta/bin/castmasta-mcp`) rather than the symlink in `/usr/bin/` to avoid any PATH issues in the service context.

**Step 2: Commit**

```bash
git add debian/castmasta.service
git commit -m "chore: add systemd unit for castmasta MCP service"
```

---

### Task 4: Create the build script

**Files:**
- Create: `scripts/build-deb.sh`
- Create: `docs/build.md`

**Step 1: Create `scripts/build-deb.sh`**

```bash
#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
VOICES_SRC="$HOME/.local/share/piper-voices"
VOICE="en_US-lessac-medium"

echo "==> Preparing voice models..."
mkdir -p "$REPO_ROOT/debian/voices"
cp "$VOICES_SRC/$VOICE.onnx" "$REPO_ROOT/debian/voices/"
cp "$VOICES_SRC/$VOICE.onnx.json" "$REPO_ROOT/debian/voices/"

mkdir -p "$REPO_ROOT/dist"

echo "==> Building arm64 deb in Docker..."
docker run --rm \
    --network=host \
    --platform linux/arm64 \
    -v "$REPO_ROOT:/build" \
    arm64v8/debian:trixie \
    bash -c "
        set -e
        apt-get update -qq
        apt-get install -y -qq --no-install-recommends \
            debhelper \
            dh-virtualenv \
            python3-dev \
            python3-pip \
            python3-venv \
            libssl-dev \
            libffi-dev \
            libasound2-dev \
            build-essential \
            patchelf \
            git
        cd /build
        dpkg-buildpackage -us -uc -b
        cp /build/../castmasta_*.deb /build/dist/
    "

echo "==> Done! Package in dist/:"
ls -lh "$REPO_ROOT/dist/"*.deb
```

Make it executable: `chmod +x scripts/build-deb.sh`

**Step 2: Create `docs/build.md`**

```markdown
# Building castmasta

## Prerequisites

- Docker with arm64/linux platform support (e.g. Docker Desktop with multi-arch, or native arm64 host)
- `en_US-lessac-medium` piper voice model at `~/.local/share/piper-voices/`

## Build

```bash
scripts/build-deb.sh
```

Output: `dist/castmasta_<version>_arm64.deb`

## Install on Pi

```bash
scp dist/castmasta_*.deb pi@<host>:~
ssh pi@<host> sudo apt install ./castmasta_*.deb
```

## Service management

```bash
sudo systemctl status castmasta
sudo systemctl restart castmasta
sudo journalctl -u castmasta -f
```

## Pairing devices

After install, run pairing as the `castmasta` user:

```bash
sudo -u castmasta /usr/lib/castmasta/bin/castmasta pair "Device Name"
```

Credentials are stored in `/var/lib/castmasta/credentials.json`.
```

**Step 3: Commit**

```bash
git add scripts/build-deb.sh docs/build.md
git commit -m "chore: add deb build script and build docs"
```

---

### Task 5: Run the build and verify

**Step 1: Run the build**

```bash
scripts/build-deb.sh
```

Expected: Docker pulls the image, installs build deps, runs `dpkg-buildpackage`, outputs `dist/castmasta_0.2.0-1_arm64.deb`.

**Step 2: Inspect the package contents**

```bash
dpkg-deb -c dist/castmasta_0.2.0-1_arm64.deb | grep -E "castmasta|piper|voice" | head -30
```

Verify:
- `/usr/lib/castmasta/` contains the venv
- `/usr/lib/castmasta/bin/piper` exists
- `/usr/share/castmasta/voices/en_US-lessac-medium.onnx` exists
- `/usr/lib/systemd/system/castmasta.service` exists

**Step 3: Check the postinst script is included**

```bash
dpkg-deb --info dist/castmasta_0.2.0-1_arm64.deb
```

Expected: shows control, postinst, prerm scripts.

**Step 4: Commit and push**

```bash
git add dist/  # only if we want to track the .deb - otherwise add dist/ to .gitignore
git commit -m "chore: initial deb build output"
git push
```

> **Note:** Consider adding `dist/*.deb` to `.gitignore` and distributing the deb via GitHub Releases or scp instead.
